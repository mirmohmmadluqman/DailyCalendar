<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1 Daily Calendar</title>
  <link rel="icon" href="Elements/myLogo.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary-dark: #121212;
      --bg-secondary-dark: #2A2A2A;
      --text-primary-dark: #E5E5E5;
      --text-heading-dark: #FFFFFF;
      --bg-primary-light: #FFFFFF;
      --bg-secondary-light: #F5F5F5;
      --text-primary-light: #333333;
      --text-heading-light: #000000;
      --accent-start: #9747FF;
      --accent-end: #FF47A8;
      --border-color-dark: #63636356;
      --border-color-light: #E5E7EB;
      --shadow: 0 10px 15px -3px rgba(0,0,0,.1), 0 4px 6px -4px rgba(0,0,0,.1);
      --transition: 0.3s ease;
      --font-size-base: 16px;
      --font-scale: 1;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      line-height: 1.5;
      background-color: var(--bg-primary-dark);
      color: var(--text-primary-dark);
      transition: background-color var(--transition), color var(--transition);
      min-height: 100vh;
    }
    body.light {
      background-color: var(--bg-primary-light);
      color: var(--text-primary-light);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--bg-secondary-dark);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--accent-start);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-end);
    }
    body.light ::-webkit-scrollbar-track {
      background: var(--bg-secondary-light);
    }
    body.light ::-webkit-scrollbar-thumb {
      background: var(--accent-start);
    }
    body.light ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-end);
    }

    header {
      position: relative;
      margin: 25px auto 0;
      display: flex;
      flex-wrap: wrap;
      width: 90%;
      max-width: 1400px;
      align-items: center;
      justify-content: space-between;
      border-radius: .5rem;
      border: 1px solid var(--border-color-dark);
      background-color: rgba(0,0,0,.2);
      padding: 0.5rem 1rem;
      box-shadow: var(--shadow);
      transition: border-color var(--transition), background-color var(--transition);
    }
    @supports (backdrop-filter: blur(4px)) {
      header {
        backdrop-filter: blur(4px);
      }
    }
    @supports not (backdrop-filter: blur(4px)) {
      header {
        background-color: rgba(0,0,0,.4);
      }
    }
    body.light header {
      border-color: var(--border-color-light);
      background-color: rgba(255,255,255,.2);
    }
    @supports not (backdrop-filter: blur(4px)) {
      body.light header {
        background-color: rgba(255,255,255,.4);
      }
    }

    .header-title-container {
      position: relative;
      display: flex;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    header h1 {
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.8);
      color: var(--text-heading-dark);
      margin: 0;
    }
    body.light header h1 {
      color: var(--text-heading-light);
    }

    button {
      cursor: pointer;
      position: relative;
      white-space: nowrap;
      border-radius: 9999px;
      border: 1px solid #363636;
      background-image: linear-gradient(to bottom, #424242, #212121);
      padding: 0.25rem 1.75rem;
      font-family: 'Inter', sans-serif;
      font-weight: 700;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      color: #FFFFFF;
      box-shadow: var(--shadow);
      transition: transform var(--transition), filter var(--transition);
      min-width: 44px;
      min-height: 44px;
    }
    body.light button {
      border-color: #D1D5DB;
      background-image: linear-gradient(to bottom, #E5E5E5, #D1D5DB);
      color: #333333;
    }
    button:hover {
      transform: scale(1.05);
      filter: brightness(1.1);
    }
    button:active {
      transform: scale(0.95);
    }
    button::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 2px;
      background: #FFFFFF;
      transition: width 0.3s ease;
    }
    body.light button::after {
      background: #333333;
    }
    button:hover::after {
      width: 80%;
    }

    #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      padding: 0;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
      margin-left: 1rem;
    }

    .header-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .calendar-header {
      margin: 2rem auto;
      width: 90%;
      max-width: 1400px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .calendar-header h2 {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      font-weight: 700;
      color: var(--text-heading-dark);
      transition: color var(--transition);
    }
    body.light .calendar-header h2 {
      color: var(--text-heading-light);
    }

    .calendar-controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
    }

    .calendar-grid {
      width: 90%;
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
    }

    .calendar-grid div {
      aspect-ratio: 1;
      border: 1px solid var(--border-color-dark);
      border-radius: 0.5rem;
      padding: 0.5rem;
      background-color: var(--bg-secondary-dark);
      position: relative;
      overflow: hidden;
      transition: background-color var(--transition), border-color var(--transition);
    }
    body.light .calendar-grid div {
      border-color: var(--border-color-light);
      background-color: var(--bg-secondary-light);
    }

    .calendar-grid .day-header {
      text-align: center;
      font-weight: 700;
      background-color: transparent;
      border: none;
    }

    .calendar-grid .day {
      cursor: pointer;
    }

    .calendar-grid .day:hover {
      background-color: rgba(151, 71, 255, 0.2);
    }

    .calendar-grid .day.today {
      border: 2px solid var(--accent-start);
    }

    .calendar-grid .day.holiday {
      background-color: rgba(255, 215, 0, 0.2);
    }

    .calendar-grid .day-number {
      position: absolute;
      top: 0.25rem;
      left: 0.25rem;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      font-weight: 700;
    }

    .calendar-grid .notes {
      margin-top: 1.5rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      max-height: calc(100% - 2rem);
      overflow-y: auto;
    }

    .calendar-grid .note {
      padding: 0.25rem;
      border-radius: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .calendar-grid .note.pinned {
      font-weight: 700;
      background-color: rgba(255, 255, 255, 0.1);
    }
    body.light .calendar-grid .note.pinned {
      background-color: rgba(0, 0, 0, 0.1);
    }

    #noteEditor, #searchPopup, #statsPopup, #settingsPopup, #timerPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      background-color: var(--bg-secondary-dark);
      border-radius: 12px;
      box-shadow: var(--shadow);
      transform: translate(-50%, -50%) scale(0.7);
      opacity: 0;
      pointer-events: none;
      transition: transform var(--transition), opacity var(--transition);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      z-index: 1000;
      overflow-y: auto;
    }
    body.light #noteEditor, body.light #searchPopup, body.light #statsPopup, body.light #settingsPopup, body.light #timerPopup {
      background-color: var(--bg-secondary-light);
    }

    #noteEditor.open, #searchPopup.open, #statsPopup.open, #settingsPopup.open, #timerPopup.open {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -50%) scale(1);
    }

    #overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition);
      z-index: 900;
    }

    #overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    #noteEditor h2, #searchPopup h2, #statsPopup h2, #settingsPopup h2, #timerPopup h2 {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      font-weight: 700;
      color: var(--text-heading-dark);
      margin-bottom: 1rem;
      transition: color var(--transition);
    }
    body.light #noteEditor h2, body.light #searchPopup h2, body.light #statsPopup h2, body.light #settingsPopup h2, body.light #timerPopup h2 {
      color: var(--text-heading-light);
    }

    #noteEditor label, #settingsPopup label {
      font-size: calc(var(--font-size-base) * var(--font-scale));
      margin-bottom: 0.25rem;
      display: block;
    }

    #noteEditor input, #noteEditor textarea, #noteEditor select, #settingsPopup input {
      width: 100%;
      padding: 0.5rem;
      margin-bottom: 0.75rem;
      font-size: calc(var(--font-size-base) * var(--font-scale));
      border-radius: 8px;
      border: 1px solid var(--border-color-dark);
      background-color: var(--bg-primary-dark);
      color: var(--text-primary-dark);
      transition: border-color var(--transition), background-color var(--transition), color var(--transition);
    }
    body.light #noteEditor input, body.light #noteEditor textarea, body.light #noteEditor select, body.light #settingsPopup input {
      border-color: var(--border-color-light);
      background-color: var(--bg-primary-light);
      color: var(--text-primary-light);
    }

    #noteEditor textarea {
      min-height: 100px;
      resize: vertical;
    }

    #noteEditor .editor-buttons, #timerPopup .timer-controls {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }

    #voiceInputBtn {
      width: 32px;
      height: 32px;
      border-radius: 9999px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #searchBar {
      margin: 0 auto;
      width: 90%;
      max-width: 600px;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-radius: 9999px;
      border: 1px solid var(--border-color-dark);
      background-color: var(--bg-secondary-dark);
      transition: border-color var(--transition), background-color var(--transition);
      margin-bottom: 1rem;
    }
    body.light #searchBar {
      border-color: var(--border-color-light);
      background-color: var(--bg-secondary-light);
    }

    #searchInput {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary-dark);
      font-size: calc(var(--font-size-base) * var(--font-scale));
      outline: none;
    }
    body.light #searchInput {
      color: var(--text-primary-light);
    }

    #searchInput::placeholder {
      color: var(--text-primary-dark);
      opacity: 0.7;
    }
    body.light #searchInput::placeholder {
      color: var(--text-primary-light);
    }

    #searchResults {
      margin-top: 1rem;
      max-height: 50vh;
      overflow-y: auto;
    }

    .search-result {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border-color-dark);
      cursor: pointer;
      transition: background-color var(--transition);
    }
    body.light .search-result {
      border-bottom-color: var(--border-color-light);
    }

    .search-result:hover {
      background-color: rgba(151, 71, 255, 0.2);
    }

    #floatingButton {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      border-radius: 9999px;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow);
    }

    .time-used, .reminder-section {
      margin-top: 0.75rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      color: var(--text-primary-dark);
      transition: color var(--transition);
    }
    body.light .time-used, body.light .reminder-section {
      color: var(--text-primary-light);
    }

    .timer-mode-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .timer-mode-buttons button {
      padding: 0.5rem 1rem;
      font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
    }

    .timer-mode-buttons button.active {
      background-image: linear-gradient(to bottom, var(--accent-start), var(--accent-end));
    }

    .timer-display {
      font-size: calc(var(--font-size-base) * var(--font-scale) * 2);
      font-weight: 700;
      text-align: center;
      margin-bottom: 1rem;
    }

    /* Media Queries for Responsiveness */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        padding: 0.5rem;
      }
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.5);
      }
      .header-title-container {
        width: 100%;
        justify-content: center;
      }
      .header-buttons {
        margin-top: 0.5rem;
        justify-content: center;
      }
      #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
        margin-left: 0;
      }
      .calendar-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.3);
      }
      .calendar-controls {
        width: 100%;
        justify-content: center;
      }
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.25rem;
      }
      .calendar-grid div {
        padding: 0.25rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      .calendar-grid .notes {
        margin-top: 1rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
      #noteEditor, #searchPopup, #statsPopup, #settingsPopup, #timerPopup {
        width: 95%;
        padding: 0.75rem;
      }
    }

    @media (max-width: 480px) {
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.2);
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.1);
      }
      .calendar-grid {
        grid-template-columns: repeat(7, 1fr);
        gap: 0.1rem;
      }
      .calendar-grid div {
        padding: 0.2rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.8);
      }
      .calendar-grid .notes {
        margin-top: 0.8rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.6);
      }
      button {
        padding: 0.25rem 1rem;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      #themeToggleBtn, #settingsBtn, #statsBtn, #timerBtn {
        width: 28px;
        height: 28px;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.9);
      }
      #floatingButton {
        width: 40px;
        height: 40px;
        font-size: calc(var(--font-size-base) * var(--font-scale) * 1.2);
      }
    }

    @media (max-width: 320px) {
      header h1 {
        font-size: calc(var(--font-size-base) * var(--font-scale));
      }
      .calendar-header h2 {
        font-size: calc(var(--font-size-base) * var(--font-scale));
      }
      .calendar-grid div {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
      .calendar-grid .day-number {
        font-size: calc(var(--font-size-base) * var(--font-scale) * 0.7);
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-title-container">
    <h1>1 Daily Calendar</h1>
    <div class="header-buttons">
      <button id="themeToggleBtn" aria-label="Toggle Theme">☀️</button>
      <button id="settingsBtn" aria-label="Settings">⚙️</button>
      <button id="statsBtn" aria-label="Statistics">📊</button>
      <button id="timerBtn" aria-label="Timer">⏰</button>
    </div>
  </div>
  <div>
    <button onclick="window.location.href='index2.html'">User Guide</button>
  </div>
</header>

<div id="searchBar">
  <input type="text" id="searchInput" placeholder="Search notes..." oninput="searchNotes()" />
  <button onclick="openSearchPopup()" aria-label="Search">🔍</button>
</div>

<div class="calendar-header">
  <h2 id="monthYear"></h2>
  <div class="calendar-controls">
    <button onclick="prevMonth()" aria-label="Previous Month">◀</button>
    <button onclick="goToToday()" aria-label="Today">Today</button>
    <button onclick="nextMonth()" aria-label="Next Month">▶</button>
    <button onclick="toggleView()" aria-label="Toggle View">📅</button>
  </div>
</div>

<div class="calendar-grid" id="calendarGrid"></div>

<button id="floatingButton" onclick="openNoteEditor(new Date())" aria-label="Add Note">+</button>

<div id="overlay"></div>
<div id="noteEditor" role="dialog" aria-modal="true" aria-labelledby="editorTitle">
  <h2 id="editorTitle">Add/Edit Note</h2>
  <label for="noteTitle">Title:</label>
  <input type="text" id="noteTitle" maxlength="50" placeholder="Enter note title" />
  <label for="noteBody">Details:</label>
  <textarea id="noteBody" placeholder="Enter note details"></textarea>
  <label for="noteColor">Color:</label>
  <input type="color" id="noteColor" value="#9747FF" />
  <label for="noteCategory">Category:</label>
  <select id="noteCategory">
    <option value="Work">Work</option>
    <option value="Personal">Personal</option>
    <option value="Other">Other</option>
  </select>
  <label for="notePriority">Priority:</label>
  <select id="notePriority">
    <option value="Low">Low</option>
    <option value="Medium">Medium</option>
    <option value="High">High</option>
  </select>
  <label for="noteRecurrence">Recurrence:</label>
  <select id="noteRecurrence">
    <option value="None">None</option>
    <option value="Daily">Daily</option>
    <option value="Weekly">Weekly</option>
    <option value="Monthly">Monthly</option>
  </select>
  <label for="noteStartTime">Start Time:</label>
  <input type="time" id="noteStartTime" />
  <label for="noteEndTime">End Time:</label>
  <input type="time" id="noteEndTime" />
  <label for="noteAttachment">Attachment (URL):</label>
  <input type="url" id="noteAttachment" placeholder="Enter URL" />
  <div class="time-used" id="timeUsed"></div>
  <div class="reminder-section">
    <label for="noteReminder">Reminder (minutes before):</label>
    <input type="number" id="noteReminder" min="0" value="0" placeholder="Set to 0 to disable" />
  </div>
  <div class="editor-buttons">
    <button onclick="saveNote()">Save</button>
    <button onclick="pinNote()">📌 Pin</button>
    <button onclick="undo()">↺ Undo</button>
    <button onclick="redo()">↻ Redo</button>
    <button id="voiceInputBtn" aria-label="Voice Input">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.47 6 6.93V22h2v-3.07c3.39-.46 6-3.4 6-6.93h-2z"/>
      </svg>
    </button>
    <button onclick="shareNote()">🔗 Share</button>
    <button onclick="closeNoteEditor()">Close</button>
  </div>
</div>

<div id="searchPopup" role="dialog" aria-modal="true" aria-labelledby="searchTitle">
  <h2 id="searchTitle">Search Results</h2>
  <div id="searchResults"></div>
  <button onclick="closeSearchPopup()">Close</button>
</div>

<div id="statsPopup" role="dialog" aria-modal="true" aria-labelledby="statsTitle">
  <h2 id="statsTitle">Statistics</h2>
  <pre id="statsContent"></pre>
  <button onclick="closeStatsPopup()">Close</button>
</div>

<div id="settingsPopup" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
  <h2 id="settingsTitle">Settings</h2>
  <label for="fontSize">Font Size:</label>
  <input type="range" id="fontSize" min="0.8" max="1.2" step="0.1" value="1" oninput="updateFontSize(this.value)" />
  <label for="themeSelect">Theme:</label>
  <select id="themeSelect" onchange="updateTheme(this.value)">
    <option value="default">Default</option>
    <option value="blue">Blue</option>
    <option value="green">Green</option>
  </select>
  <label for="languageSelect">Language:</label>
  <select id="languageSelect">
    <option value="en">English</option>
    <option value="es">Spanish</option>
  </select>
  <label for="highContrast">High-Contrast Mode:</label>
  <input type="checkbox" id="highContrast" onchange="toggleHighContrast(this.checked)" />
  <label for="reminderInterval">Reminder Interval (minutes):</label>
  <input type="number" id="reminderInterval" min="0" value="0" placeholder="Set to 0 to disable" />
  <button onclick="saveSettings()">Save</button>
  <button onclick="closeSettingsPopup()">Close</button>
</div>

<div id="timerPopup" role="dialog" aria-modal="true" aria-labelledby="timerTitle">
  <h2 id="timerTitle">Pomodoro Timer</h2>
  <div class="timer-mode-buttons">
    <button class="active" onclick="setTimerMode('pomodoro')">Pomodoro</button>
    <button onclick="setTimerMode('short')">Short Break</button>
    <button onclick="setTimerMode('long')">Long Break</button>
  </div>
  <div class="timer-display" id="timerDisplay">25:00</div>
  <div class="timer-controls">
    <button id="timerStartBtn" onclick="startTimer()">Start</button>
    <button id="timerPauseBtn" onclick="pauseTimer()" disabled>Pause</button>
    <button id="timerResumeBtn" onclick="resumeTimer()" disabled>Resume</button>
    <button id="timerStopBtn" onclick="stopTimer()" disabled>Stop</button>
    <button onclick="closeTimerPopup()">Close</button>
  </div>
</div>

<script>
(() => {
  let currentDate = new Date(2025, 4, 24);
  let currentView = 'month';
  let notes = JSON.parse(localStorage.getItem('calendarNotes')) || {};
  let focusData = JSON.parse(localStorage.getItem('focusData')) || {};
  let undoStack = [];
  let redoStack = [];
  let currentNote = null;
  let currentDateKey = '';
  let lightTheme = false;
  let timer;
  let timerTime = 1500; // Default Pomodoro time in seconds
  let timerMode = 'pomodoro';
  let timerRunning = false;
  let timerPaused = false;
  let timerDurations = {
    pomodoro: 25 * 60,
    short: 5 * 60,
    long: 15 * 60
  };
  let reminderInterval = 0;
  let lastReminderTime = Date.now();

  const holidays = {
    '2025-01-01': 'New Year',
    '2025-12-25': 'Christmas'
  };

  function init() {
    loadTheme();
    loadSettings();
    renderCalendar();
    bindEvents();
    requestNotificationPermission();
  }

  function loadTheme() {
    lightTheme = localStorage.getItem('theme') === 'light';
    document.body.classList.toggle('light', lightTheme);
    document.getElementById('themeToggleBtn').textContent = lightTheme ? '🌙' : '☀️';
  }

  function loadSettings() {
    const savedSettings = JSON.parse(localStorage.getItem('calendarSettings')) || {};
    if (savedSettings.fontSize) {
      document.documentElement.style.setProperty('--font-scale', savedSettings.fontSize);
      document.getElementById('fontSize').value = savedSettings.fontSize;
    }
    if (savedSettings.theme) {
      updateTheme(savedSettings.theme);
      document.getElementById('themeSelect').value = savedSettings.theme;
    }
    if (savedSettings.highContrast) {
      toggleHighContrast(savedSettings.highContrast);
      document.getElementById('highContrast').checked = savedSettings.highContrast;
    }
    if (savedSettings.reminderInterval) {
      reminderInterval = savedSettings.reminderInterval;
      document.getElementById('reminderInterval').value = reminderInterval / 60;
    }
    if (savedSettings.timerDurations) {
      timerDurations = savedSettings.timerDurations;
      timerTime = timerDurations[timerMode];
      updateTimerDisplay();
    }
  }

  function bindEvents() {
    document.getElementById('themeToggleBtn').onclick = () => {
      lightTheme = !lightTheme;
      document.body.classList.toggle('light', lightTheme);
      document.getElementById('themeToggleBtn').textContent = lightTheme ? '🌙' : '☀️';
      localStorage.setItem('theme', lightTheme ? 'light' : 'dark');
    };
    document.getElementById('settingsBtn').onclick = openSettingsPopup;
    document.getElementById('statsBtn').onclick = openStatsPopup;
    document.getElementById('timerBtn').onclick = openTimerPopup;
    document.getElementById('voiceInputBtn').onclick = startVoiceInput;
    document.addEventListener('keydown', handleKeyboardShortcuts);
  }

  function renderCalendar() {
    const calendarGrid = document.getElementById('calendarGrid');
    calendarGrid.innerHTML = '';
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(day => {
      const dayHeader = document.createElement('div');
      dayHeader.className = 'day-header';
      dayHeader.textContent = day;
      calendarGrid.appendChild(dayHeader);
    });

    const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
    const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
    document.getElementById('monthYear').textContent = `${currentDate.toLocaleString('default', { month: 'long' })} ${currentDate.getFullYear()}`;

    for (let i = 0; i < firstDay; i++) {
      const emptyDay = document.createElement('div');
      calendarGrid.appendChild(emptyDay);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
      const dateKey = date.toISOString().split('T')[0];
      const dayDiv = document.createElement('div');
      dayDiv.className = 'day';
      if (dateKey === new Date().toISOString().split('T')[0]) {
        dayDiv.classList.add('today');
      }
      if (holidays[dateKey]) {
        dayDiv.classList.add('holiday');
      }
      dayDiv.innerHTML = `<span class="day-number">${day}</span>`;
      const notesDiv = document.createElement('div');
      notesDiv.className = 'notes';
      const dayNotes = notes[dateKey] || [];
      dayNotes.sort((a, b) => b.pinned - a.pinned);
      dayNotes.forEach(note => {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note';
        if (note.pinned) noteDiv.classList.add('pinned');
        noteDiv.style.backgroundColor = note.color + '33';
        noteDiv.textContent = note.title;
        notesDiv.appendChild(noteDiv);
      });
      dayDiv.appendChild(notesDiv);
      dayDiv.onclick = () => openNoteEditor(date);
      calendarGrid.appendChild(dayDiv);
    }
  }

  function prevMonth() {
    currentDate.setMonth(currentDate.getMonth() - 1);
    renderCalendar();
  }

  function nextMonth() {
    currentDate.setMonth(currentDate.getMonth() + 1);
    renderCalendar();
  }

  function goToToday() {
    currentDate = new Date(2025, 4, 24);
    renderCalendar();
  }

  function toggleView() {
    currentView = currentView === 'month' ? 'week' : 'month';
    renderCalendar();
  }

  function openNoteEditor(date) {
    currentDateKey = date.toISOString().split('T')[0];
    document.getElementById('editorTitle').textContent = `Add/Edit Note - ${currentDateKey}`;
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteBody').value = '';
    document.getElementById('noteColor').value = '#9747FF';
    document.getElementById('noteCategory').value = 'Work';
    document.getElementById('notePriority').value = 'Low';
    document.getElementById('noteRecurrence').value = 'None';
    document.getElementById('noteStartTime').value = '';
    document.getElementById('noteEndTime').value = '';
    document.getElementById('noteAttachment').value = '';
    document.getElementById('noteReminder').value = '0';
    currentNote = null;
    undoStack = [];
    redoStack = [];
    updateTimeUsed();
    document.getElementById('noteEditor').classList.add('open');
    document.getElementById('overlay').classList.add('open');
  }

  function updateTimeUsed() {
    const mins = Math.floor((focusData[currentDateKey] || 0) / 60);
    document.getElementById('timeUsed').textContent = `Focus Time on ${currentDateKey}: ${mins} min`;
  }

  function saveNote() {
    const note = {
      title: document.getElementById('noteTitle').value,
      body: document.getElementById('noteBody').value,
      color: document.getElementById('noteColor').value,
      category: document.getElementById('noteCategory').value,
      priority: document.getElementById('notePriority').value,
      recurrence: document.getElementById('noteRecurrence').value,
      startTime: document.getElementById('noteStartTime').value,
      endTime: document.getElementById('noteEndTime').value,
      attachment: document.getElementById('noteAttachment').value,
      pinned: currentNote ? currentNote.pinned : false,
      reminder: parseInt(document.getElementById('noteReminder').value) * 60
    };
    if (!notes[currentDateKey]) notes[currentDateKey] = [];
    if (currentNote) {
      const index = notes[currentDateKey].indexOf(currentNote);
      notes[currentDateKey][index] = note;
    } else {
      notes[currentDateKey].push(note);
    }
    if (note.reminder > 0 && note.startTime) {
      scheduleReminder(note, currentDateKey);
    }
    localStorage.setItem('calendarNotes', JSON.stringify(notes));
    renderCalendar();
    closeNoteEditor();
  }

  function scheduleReminder(note, dateKey) {
    if (!note.startTime) return;
    const [hours, minutes] = note.startTime.split(':').map(Number);
    const reminderTime = new Date(dateKey);
    reminderTime.setHours(hours, minutes, 0, 0);
    reminderTime.setSeconds(reminderTime.getSeconds() - note.reminder);
    const now = new Date();
    const timeDiff = reminderTime - now;
    if (timeDiff > 0 && Notification.permission === 'granted') {
      setTimeout(() => {
        new Notification('1 Daily Calendar Reminder', {
          body: `Reminder: ${note.title} at ${note.startTime}`,
          icon: 'https://via.placeholder.com/150'
        });
      }, timeDiff);
    }
  }

  function pinNote() {
    if (currentNote) {
      currentNote.pinned = !currentNote.pinned;
      saveNote();
    }
  }

  function undo() {
    // Placeholder for undo functionality
  }

  function redo() {
    // Placeholder for redo functionality
  }

  function startVoiceInput() {
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      document.getElementById('noteBody').value += transcript + ' ';
    };
    recognition.onerror = () => {
      alert('Voice input failed. Please ensure your browser supports speech recognition and your microphone is enabled.');
    };
    recognition.start();
  }

  function shareNote() {
    const note = {
      title: document.getElementById('noteTitle').value,
      body: document.getElementById('noteBody').value,
      date: currentDateKey
    };
    const shareText = `${note.title}\n${note.body}\nDate: ${note.date}`;
    navigator.clipboard.writeText(shareText).then(() => {
      alert('Note copied to clipboard!');
    });
  }

  function closeNoteEditor() {
    document.getElementById('noteEditor').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  function searchNotes() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const results = [];
    for (const dateKey in notes) {
      notes[dateKey].forEach(note => {
        if (
          note.title.toLowerCase().includes(query) ||
          note.body.toLowerCase().includes(query) ||
          note.category.toLowerCase().includes(query) ||
          dateKey.includes(query)
        ) {
          results.push({ date: dateKey, note });
        }
      });
    }
    displaySearchResults(results);
  }

  function displaySearchResults(results) {
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '';
    results.forEach(result => {
      const resultDiv = document.createElement('div');
      resultDiv.className = 'search-result';
      resultDiv.textContent = `${result.date}: ${result.note.title}`;
      resultDiv.onclick = () => {
        currentDate = new Date(result.date);
        renderCalendar();
        openNoteEditor(new Date(result.date));
        currentNote = result.note;
        document.getElementById('noteTitle').value = result.note.title;
        document.getElementById('noteBody').value = result.note.body;
        document.getElementById('noteColor').value = result.note.color;
        document.getElementById('noteCategory').value = result.note.category;
        document.getElementById('notePriority').value = result.note.priority;
        document.getElementById('noteRecurrence').value = result.note.recurrence;
        document.getElementById('noteStartTime').value = result.note.startTime;
        document.getElementById('noteEndTime').value = result.note.endTime;
        document.getElementById('noteAttachment').value = result.note.attachment;
        document.getElementById('noteReminder').value = result.note.reminder / 60;
        closeSearchPopup();
      };
      searchResults.appendChild(resultDiv);
    });
  }

  function openSearchPopup() {
    document.getElementById('searchPopup').classList.add('open');
    document.getElementById('overlay').classList.add('open');
  }

  function closeSearchPopup() {
    document.getElementById('searchPopup').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  function openStatsPopup() {
    const totalNotes = Object.values(notes).flat().length;
    let activeDays = 0;
    for (const dateKey in notes) {
      if (notes[dateKey].length > 0) activeDays++;
    }
    let dailyReport = '';
    let weeklyReport = '';
    let monthlyReport = '';
    const now = new Date();
    const todayKey = now.toISOString().split('T')[0];
    dailyReport = `📌 Today (${todayKey}): ${Math.floor((focusData[todayKey] || 0) / 60)} min\n`;
    for (const key in focusData) {
      if (key.includes('-') && !key.startsWith('month-') && !key.startsWith('year-') && key !== todayKey) {
        dailyReport += `📌 ${key}: ${Math.floor(focusData[key] / 60)} min\n`;
      }
    }
    const weekData = {};
    for (const key in focusData) {
      if (key.includes('-') && !key.startsWith('month-') && !key.startsWith('year-')) {
        const date = new Date(key);
        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
        const weekKey = `${date.getFullYear()}-W${String(weekNumber).padStart(2, '0')}`;
        weekData[weekKey] = (weekData[weekKey] || 0) + (focusData[key] || 0);
      }
    }
    for (const week in weekData) {
      weeklyReport += `📅 Week ${week}: ${Math.floor(weekData[week] / 60)} min\n`;
    }
    for (const key in focusData) {
      if (key.startsWith('month-')) {
        monthlyReport += `📆 ${key.split('-')[1]}: ${Math.floor(focusData[key] / 60)} min\n`;
      }
    }
    const stats = `Total Notes: ${totalNotes}\nMost Active Days: ${activeDays}\n\n` +
                  `Daily Focus Time:\n${dailyReport || 'No daily data.\n'}\n` +
                  `Weekly Focus Time:\n${weeklyReport || 'No weekly data.\n'}\n` +
                  `Monthly Focus Time:\n${monthlyReport || 'No monthly data.\n'}`;
    document.getElementById('statsContent').textContent = stats;
    document.getElementById('statsPopup').classList.add('open');
    document.getElementById('overlay').classList.add('open');
  }

  function closeStatsPopup() {
    document.getElementById('statsPopup').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  function openSettingsPopup() {
    document.getElementById('settingsPopup').classList.add('open');
    document.getElementById('overlay').classList.add('open');
  }

  function closeSettingsPopup() {
    document.getElementById('settingsPopup').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  function updateFontSize(value) {
    document.documentElement.style.setProperty('--font-scale', value);
  }

  function updateTheme(theme) {
    // Placeholder for theme updates
  }

  function toggleHighContrast(enabled) {
    // Placeholder for high-contrast mode
  }

  function saveSettings() {
    const settings = {
      fontSize: document.getElementById('fontSize').value,
      theme: document.getElementById('themeSelect').value,
      language: document.getElementById('languageSelect').value,
      highContrast: document.getElementById('highContrast').checked,
      reminderInterval: parseInt(document.getElementById('reminderInterval').value) * 60,
      timerDurations
    };
    reminderInterval = settings.reminderInterval;
    localStorage.setItem('calendarSettings', JSON.stringify(settings));
    closeSettingsPopup();
  }

  function openTimerPopup() {
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
    document.getElementById('timerPopup').classList.add('open');
    document.getElementById('overlay').classList.add('open');
  }

  function closeTimerPopup() {
    stopTimer();
    document.getElementById('timerPopup').classList.remove('open');
    document.getElementById('overlay').classList.remove('open');
  }

  function setTimerMode(newMode) {
    document.querySelectorAll('.timer-mode-buttons button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    timerMode = newMode;
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
    stopTimer();
  }

  function updateTimerDisplay() {
    const minutes = Math.floor(timerTime / 60).toString().padStart(2, '0');
    const seconds = (timerTime % 60).toString().padStart(2, '0');
    document.getElementById('timerDisplay').textContent = `${minutes}:${seconds}`;
  }

  function startTimer() {
    if (timerRunning) return;
    timerRunning = true;
    timerPaused = false;
    document.getElementById('timerStartBtn').disabled = true;
    document.getElementById('timerPauseBtn').disabled = false;
    document.getElementById('timerResumeBtn').disabled = true;
    document.getElementById('timerStopBtn').disabled = false;
    timer = setInterval(() => {
      timerTime--;
      updateTimerDisplay();
      checkReminder();
      if (timerTime <= 0) {
        clearInterval(timer);
        timerRunning = false;
        recordFocusTime(timerDurations[timerMode]);
        autoSwitchTimerMode();
      }
    }, 1000);
  }

  function pauseTimer() {
    if (!timerRunning || timerPaused) return;
    clearInterval(timer);
    timerRunning = false;
    timerPaused = true;
    document.getElementById('timerStartBtn').disabled = true;
    document.getElementById('timerPauseBtn').disabled = true;
    document.getElementById('timerResumeBtn').disabled = false;
    document.getElementById('timerStopBtn').disabled = false;
    if (timerMode === 'pomodoro') {
      const used = timerDurations.pomodoro - timerTime;
      recordFocusTime(used);
    }
  }

  function resumeTimer() {
    if (timerRunning || !timerPaused) return;
    startTimer();
  }

  function stopTimer() {
    clearInterval(timer);
    timerRunning = false;
    timerPaused = false;
    document.getElementById('timerStartBtn').disabled = false;
    document.getElementById('timerPauseBtn').disabled = true;
    document.getElementById('timerResumeBtn').disabled = true;
    document.getElementById('timerStopBtn').disabled = true;
    timerTime = timerDurations[timerMode];
    updateTimerDisplay();
  }

  function autoSwitchTimerMode() {
    if (timerMode === 'pomodoro') {
      setTimerMode('short');
      startTimer();
    } else {
      setTimerMode('pomodoro');
      startTimer();
    }
  }

  function recordFocusTime(seconds) {
    if (timerMode !== 'pomodoro') return;
    const todayKey = new Date().toISOString().split('T')[0];
    const monthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
    const yearKey = `${new Date().getFullYear()}`;
    focusData[todayKey] = (focusData[todayKey] || 0) + seconds;
    const storedMonth = localStorage.getItem('lastMonthKey');
    if (storedMonth && storedMonth !== monthKey) {
      let monthTotal = 0;
      for (const key in focusData) {
        if (key.startsWith(storedMonth)) {
          monthTotal += focusData[key];
          delete focusData[key];
        }
      }
      focusData[`month-${storedMonth}`] = monthTotal;
    }
    localStorage.setItem('lastMonthKey', monthKey);
    const storedYear = localStorage.getItem('lastYearKey');
    if (storedYear && storedYear !== yearKey) {
      let yearTotal = 0;
      for (const key in focusData) {
        if (key.startsWith(`month-${storedYear}`)) {
          yearTotal += focusData[key];
          delete focusData[key];
        }
      }
      focusData[`year-${storedYear}`] = yearTotal;
    }
    localStorage.setItem('lastYearKey', yearKey);
    localStorage.setItem('focusData', JSON.stringify(focusData));
    updateTimeUsed();
  }

  function requestNotificationPermission() {
    if (Notification.permission !== 'granted') {
      Notification.requestPermission();
    }
  }

  function checkReminder() {
    if (reminderInterval === 0 || !timerRunning) return;
    const now = Date.now();
    if ((now - lastReminderTime) / 1000 >= reminderInterval) {
      if (Notification.permission === 'granted') {
        new Notification('1 Daily Calendar Reminder', {
          body: 'Keep focused! Take a break if needed.',
          icon: 'https://via.placeholder.com/150'
        });
      }
      lastReminderTime = now;
    }
  }

  function handleKeyboardShortcuts(e) {
    if (e.ctrlKey && e.key === 't') goToToday();
    if (e.ctrlKey && e.key === 'n') openNoteEditor(new Date());
  }

  init();
})();
</script>
</body>
</html>
